#!/usr/bin/env bash

set -euo pipefail

REMOTE_HOST="idbox@idbox.home.lan"
REMOTE_BASE_DIR="bash-history"

usage() {
    local script_name
    script_name="$(basename "$0")"
    cat <<EOF
Usage: $script_name <push|pull> <beelink|fw13|fw-desktop>

Examples:
  $script_name push fw13
  $script_name pull beelink
EOF
    exit 1
}

if (( $# != 2 )); then
    usage
fi

action="$1"
target="$2"

# Validate target
case "$target" in
    beelink|fw13|fw-desktop)
        ;;
    *)
        echo "Invalid target: $target"
        echo "Allowed: beelink, fw13, fw-desktop"
        exit 1
        ;;
esac

push_history() {
    local t="$1"

    if [[ ! -f "$HOME/.bash_history" ]]; then
        echo "ERROR: $HOME/.bash_history does not exist" >&2
        exit 1
    fi

    echo "Pushing $HOME/.bash_history to $REMOTE_HOST:~/$REMOTE_BASE_DIR/$t/"
    scp "$HOME/.bash_history" \
        "$REMOTE_HOST:~/$REMOTE_BASE_DIR/$t/"
}

pull_history() {
    local t="$1"

    read -p "Restoring bash history from '$t'. This will overwrite your local ~/.bash_history (after backup). Continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    # Backup current history, if it exists
    if [[ -f "$HOME/.bash_history" ]]; then
        local ts backup
        ts="$(date +%Y%m%dT%H%M%S)"
        backup="$HOME/.bash_history.bak.$ts"
        mv "$HOME/.bash_history" "$backup"
        echo "Moved current ~/.bash_history to: $backup"
    fi

    # Restore from remote
    echo "Restoring from $REMOTE_HOST:~/$REMOTE_BASE_DIR/$t/.bash_history"
    scp "$REMOTE_HOST:~/$REMOTE_BASE_DIR/$t/.bash_history" "$HOME/"

    echo "Restored ~/.bash_history from '$t'"
}

case "$action" in
    push)
        push_history "$target"
        ;;
    pull)
        pull_history "$target"
        ;;
    *)
        usage
        ;;
esac

